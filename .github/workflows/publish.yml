name: Publish Package

on:
  push:
    branches: [main]
    tags: ["v*"]

permissions:
  contents: write
  packages: write
  id-token: write  # For npm OIDC authentication

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout source (with tags so we can compare versions)
      # ------------------------------------------------------------
      - name: ğŸ›ï¸  Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Node & dependency setup
      # ------------------------------------------------------------
      - name: ğŸ”§ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ------------------------------------------------------------
      # Determine version and whether publish is needed
      # ------------------------------------------------------------
      - name: ğŸ·ï¸  Get current version
        id: version
        run: |
          ver=$(node -p "require('./package.json').version")
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: ğŸ” Check if publish needed
        id: check
        run: |
          git fetch --prune --unshallow || true
          PREV=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          CURR="v${{ steps.version.outputs.version }}"
          echo "Latest tag: $PREV  â€¢  package.json: $CURR"
          if [ "$PREV" != "$CURR" ]; then
            echo "needs_publish=true"  >> "$GITHUB_OUTPUT"
          else
            echo "needs_publish=false" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Build & publish only if version changed
      # ------------------------------------------------------------
      - name: ğŸ› ï¸  Build
        if: steps.check.outputs.needs_publish == 'true'
        run: npm run build

      - name: ğŸš€ Publish to GitHub Packages
        if: steps.check.outputs.needs_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm publish

      - name: ğŸ“¦ Publish to npmjs.org
        if: steps.check.outputs.needs_publish == 'true'
        run: npm publish --registry https://registry.npmjs.org --provenance --access public

      - name: ğŸ·ï¸  Create git tag
        if: steps.check.outputs.needs_publish == 'true'
        run: |
          git config user.email "action@github.com"
          git config user.name  "GitHub Action"
          TAG="v${{ steps.version.outputs.version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
